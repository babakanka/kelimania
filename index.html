<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KeliMania - TÃ¼rkÃ§e Kelime Oyunu</title>
    
    <meta name="description" content="TÃ¼rkÃ§e kelime oluÅŸturma ve strateji oyunu. TDK SÃ¶zlÃ¼k destekli.">
    <meta name="theme-color" content="#7c3aed">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="KeliMania">
    <meta name="mobile-web-app-capable" content="yes">
    
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='105' fill='%237c3aed'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='280' fill='white' font-family='system-ui, sans-serif' font-weight='bold'%3EKM%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%237c3aed'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='60' fill='white' font-family='system-ui' font-weight='bold'%3EK%3C/text%3E%3C/svg%3E">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif;
            overflow-x: hidden;
            touch-action: manipulation;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        #root { 
            width: 100%; 
            min-height: 100vh; 
        }
        
        /* Board Cells - Enhanced */
        .board-cell {
            aspect-ratio: 1;
            border: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            font-weight: 900;
            user-select: none;
            touch-action: manipulation;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 4px;
            background: white;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
        }
        
        .board-cell:active {
            transform: scale(0.95);
        }
        
        .triple-letter { 
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            color: white;
            font-weight: 900;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3), inset 0 1px 2px rgba(255,255,255,0.3);
            border: 2px solid #2563eb;
        }
        
        .double-word { 
            background: linear-gradient(135deg, #f472b6 0%, #ec4899 100%);
            color: white;
            font-weight: 900;
            box-shadow: 0 2px 8px rgba(236, 72, 153, 0.3), inset 0 1px 2px rgba(255,255,255,0.3);
            border: 2px solid #db2777;
        }
        
        .center-star { 
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            font-weight: 900;
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.4), inset 0 1px 2px rgba(255,255,255,0.3);
            border: 2px solid #d97706;
            animation: pulse-star 2s ease-in-out infinite;
        }
        
        @keyframes pulse-star {
            0%, 100% { box-shadow: 0 2px 8px rgba(251, 191, 36, 0.4), inset 0 1px 2px rgba(255,255,255,0.3); }
            50% { box-shadow: 0 4px 16px rgba(251, 191, 36, 0.6), inset 0 1px 2px rgba(255,255,255,0.5); }
        }
        
        /* Letter Tiles - 3D Effect */
        .letter-tile {
            position: relative;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 
                0 1px 3px rgba(0,0,0,0.12),
                0 1px 2px rgba(0,0,0,0.24),
                inset 0 -2px 0 rgba(0,0,0,0.1),
                inset 0 1px 0 rgba(255,255,255,0.6);
        }
        
        .letter-tile:not(.disabled):hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 
                0 8px 16px rgba(0,0,0,0.15),
                0 4px 6px rgba(0,0,0,0.1),
                inset 0 -2px 0 rgba(0,0,0,0.1),
                inset 0 1px 0 rgba(255,255,255,0.6);
        }
        
        .letter-tile:not(.disabled):active {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.15),
                0 1px 2px rgba(0,0,0,0.1),
                inset 0 -1px 0 rgba(0,0,0,0.1),
                inset 0 1px 0 rgba(255,255,255,0.6);
        }
        
        .letter-tile.selected {
            animation: bounce 0.5s ease-in-out;
            box-shadow: 
                0 0 0 3px #10b981,
                0 8px 16px rgba(16, 185, 129, 0.4),
                inset 0 -2px 0 rgba(0,0,0,0.1),
                inset 0 1px 0 rgba(255,255,255,0.6);
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* Score Animation */
        @keyframes score-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .score-pop {
            animation: score-pop 0.5s ease-in-out;
        }
        
        /* Button Styles - Enhanced */
        .btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .btn:active:not(:disabled) {
            transform: scale(0.95);
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .btn-primary:hover:not(:disabled) {
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.5);
        }
        
        /* Splash Screen - Enhanced */
        #splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }
        
        #splash.hide {
            opacity: 0;
            pointer-events: none;
        }
        
        .splash-logo {
            font-size: 120px;
            margin-bottom: 20px;
            animation: splash-float 3s ease-in-out infinite;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
        }
        
        @keyframes splash-float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        .splash-text {
            font-size: 48px;
            font-weight: 900;
            color: white;
            margin-bottom: 10px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
            letter-spacing: -1px;
        }
        
        .splash-subtitle {
            font-size: 18px;
            color: rgba(255,255,255,0.9);
            font-weight: 600;
        }
        
        /* Message Toast - Enhanced */
        .message-toast {
            animation: toast-slide-up 0.3s ease-out;
        }
        
        @keyframes toast-slide-up {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Word Preview - Enhanced */
        .word-preview {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-left: 4px solid #10b981;
        }
        
        /* Glow Effect */
        .glow {
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.6);
        }
        
        /* Responsive Font Sizes */
        @media (max-width: 768px) {
            .board-cell {
                font-size: 7px;
                border-width: 1px;
            }
            .splash-logo {
                font-size: 80px;
            }
            .splash-text {
                font-size: 36px;
            }
        }
        
        @media (min-width: 769px) {
            .board-cell {
                font-size: 11px;
            }
        }
        
        /* Pulse Animation for Notifications */
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
            }
            50% { 
                box-shadow: 0 0 20px rgba(239, 68, 68, 0.8);
            }
        }
        
        .pulse-warning {
            animation: pulse-glow 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splash">
        <div class="splash-logo">ðŸŽ®</div>
        <div class="splash-text">KeliMania</div>
        <div class="splash-subtitle">TÃ¼rkÃ§e Kelime Oyunu</div>
    </div>
    
    <div id="root"></div>
    
    <script>
// Haptic Feedback Helper
function vibrate(pattern) {
    if ('vibrate' in navigator) {
        navigator.vibrate(pattern);
    }
}

// Register Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
            .then(reg => console.log('âœ… Service Worker registered'))
            .catch(err => console.log('âŒ Service Worker failed'));
    });
}

// Hide splash screen
window.addEventListener('load', () => {
    setTimeout(() => {
        document.getElementById('splash').classList.add('hide');
    }, 2000);
});

// Game code
const h = React.createElement;
const { useState, useEffect } = React;
const { createRoot } = ReactDOM;

const BOARD_SIZE = 15;
const TRIPLE_LETTER = [[3,3],[3,11],[11,3],[11,11]];
const DOUBLE_WORD = [[7,3],[7,11],[3,7],[11,7]];

const POINTS = {
  A:1,B:5,C:6,Ã‡:6,D:4,E:1,F:8,G:5,Äž:8,H:6,I:5,Ä°:5,J:10,K:3,L:3,M:4,
  N:2,O:5,Ã–:7,P:7,R:2,S:4,Åž:6,T:3,U:4,Ãœ:6,V:7,Y:4,Z:6
};

const LETTERS = ['A','B','C','Ã‡','D','E','F','G','Äž','H','I','Ä°','J','K','L','M','N','O','Ã–','P','R','S','Åž','T','U','Ãœ','V','Y','Z'];

const COMMON_WORDS = [
  'MASA','KAPI','EV','AÄžAÃ‡','ARABA','KITAP','KALEM','DEFTER','OKUL','Ã–ÄžRENCÄ°',
  'Ã–ÄžRETMEN','ANNE','BABA','KARDEÅž','ARKADAÅž','OYUN','TOP','BAL','SU','YER',
  'GÃ–K','GÃœNEÅž','AY','YILDIZ','DENIZ','DAÄž','ORMAN','Ã‡Ä°Ã‡EK','BAHÃ‡E','PARK',
  'HAYVAN','KEDÄ°','KÃ–PEK','KUÅž','BALIK','AT','Ä°NEK','KOYUN','TAVUK','HOROZ',
  'ELBÄ°SE','AYAKKABI','ÅžAPKA','PANTOLON','GÃ–MLEK','CEKET','ETEK','Ä°Ã‡','DIÅž','ÃœST',
  'ALT','SAÄž','SOL','Ã–N','ARKA','BÃœYÃœK','KÃœÃ‡ÃœK','UZUN','KISA','YENÄ°',
  'ESKÄ°','GÃœZEL','Ã‡Ä°RKÄ°N','Ä°YÄ°','KÃ–TÃœ','SICAK','SOÄžUK','AÃ‡IK','KAPALI','KOLAY',
  'ZOR','HIZLI','YAVAÅž','GENÄ°Åž','DAR','TOK','AÃ‡','TATLI','TUZLU','EKÅžÄ°',
  'ACI','SERT','YUMUÅžAK','KURU','ISLAK','TEMÄ°Z','KÄ°RLÄ°','DOLU','BOÅž','AÄžIR',
  'HAFÄ°F','YAKIN','UZAK','YENÄ°DEN','ESKÄ°DEN','ÅžÄ°MDÄ°','SONRA','Ã–NCE','HER','HÄ°Ã‡',
  'BÄ°R','Ä°KÄ°','ÃœÃ‡','DÃ–RT','BEÅž','ALTI','YEDÄ°','SEKÄ°Z','DOKUZ','ON',
  'YÃœZ','BÄ°N','MÄ°LYON','BUGÃœN','DÃœN','YARIN','GÃœN','SAAT','DAKÄ°KA','SANÄ°YE',
  'HAFTA','Ä°LKBAHAR','YAZ','SONBAHAR','KIÅž','SABAH','Ã–ÄžLE','AKÅžAM','GECE','YEMEK',
  'Ä°Ã‡MEK','UYUMAK','GÄ°TMEK','GELMEK','ALMAK','VERMEK','YAPMAK','GÃ–RMEK','SEVMEKÄ°'
];

const wordCache = new Map();
COMMON_WORDS.forEach(word => wordCache.set(word, true));

const checkWordWithTDK = async (word) => {
  const normalized = word.toUpperCase().trim();
  if (normalized.length < 2) return false;
  
  if (wordCache.has(normalized)) {
    return wordCache.get(normalized);
  }
  
  try {
    const apiUrl = 'https://kaleidoscopic-bienenstitch-3cb160.netlify.app/.netlify/functions/check?word=' + encodeURIComponent(normalized);
    const response = await fetch(apiUrl);
    if (!response.ok) {
      wordCache.set(normalized, false);
      return false;
    }
    const data = await response.json();
    const isValid = data.valid === true;
    wordCache.set(normalized, isValid);
    return isValid;
  } catch (error) {
    wordCache.set(normalized, false);
    return false;
  }
};

function Game() {
  const initBag = () => {
    const b = [];
    LETTERS.forEach(l => { for(let i=0;i<3;i++) b.push(l); });
    for(let i=0;i<3;i++) b.push('*');
    return b.sort(() => Math.random()-0.5);
  };
  
  const ensureVowels = (hand) => {
    const vowels = ['A','E','I','Ä°','O','Ã–','U','Ãœ'];
    const vc = hand.filter(l => vowels.includes(l)).length;
    if(vc >= 2) return hand;
    const nh = [...hand];
    const ci = [];
    nh.forEach((l,i) => { if(!vowels.includes(l) && l !== '*') ci.push(i); });
    const sc = ci.sort(() => Math.random()-0.5);
    for(let i=0; i<(2-vc) && i<sc.length; i++) {
      nh[sc[i]] = vowels[Math.floor(Math.random()*vowels.length)];
    }
    return nh;
  };
  
  const [bag, setBag] = useState(initBag);
  const [p1Hand, setP1Hand] = useState(() => ensureVowels(bag.slice(0,7)));
  const [p2Hand, setP2Hand] = useState(() => ensureVowels(bag.slice(7,14)));
  const [board, setBoard] = useState(() => Array(BOARD_SIZE).fill(null).map(() => Array(BOARD_SIZE).fill(null)));
  const [temp, setTemp] = useState([]);
  const [turn, setTurn] = useState(1);
  const [p1Score, setP1Score] = useState(0);
  const [p2Score, setP2Score] = useState(0);
  const [msg, setMsg] = useState('');
  const [selectedLetter, setSelectedLetter] = useState(null);
  const [checking, setChecking] = useState(false);
  const [wordPreview, setWordPreview] = useState({valid:[],invalid:[]});
  const [jokerIdx, setJokerIdx] = useState(null);
  const [showJokerModal, setShowJokerModal] = useState(false);
  const [swapMode, setSwapMode] = useState(false);
  const [selectedSwap, setSelectedSwap] = useState([]);
  const [showWinner, setShowWinner] = useState(false);
  const [winner, setWinner] = useState(null);
  const [passCount, setPassCount] = useState(0);
  const [scoreAnimation, setScoreAnimation] = useState(false);
  
  const p1Color = '#ef4444';
  const p2Color = '#eab308';
  
  // Score animation effect
  useEffect(() => {
    if (scoreAnimation) {
      const timer = setTimeout(() => setScoreAnimation(false), 500);
      return () => clearTimeout(timer);
    }
  }, [scoreAnimation]);
  
  const isValid = (r,c,color) => {
    if(board[r][c]) return false;
    if(temp.find(t=>t.r===r&&t.c===c)) return false;
    const dn = [[r-1,c],[r+1,c],[r,c-1],[r,c+1]];
    for(const [nr,nc] of dn) {
      if(nr<0||nr>=BOARD_SIZE||nc<0||nc>=BOARD_SIZE) continue;
      const n = board[nr][nc];
      if(n && n.color!==color) return false;
      const nt = temp.find(t=>t.r===nr&&t.c===nc);
      if(nt && nt.color!==color) return false;
    }
    return true;
  };
  
  const findWords = (tempTiles) => {
    if(tempTiles.length === 0) return [];
    const tb = board.map(row => [...row]);
    tempTiles.forEach(t => { tb[t.r][t.c] = {letter:t.letter,isNew:true}; });
    const words = [];
    for(let r=0; r<BOARD_SIZE; r++) {
      let w='',hn=false;
      for(let c=0; c<BOARD_SIZE; c++) {
        if(tb[r][c]) { w+=tb[r][c].letter; if(tb[r][c].isNew) hn=true; }
        else { if(w.length>=2&&hn) words.push(w); w=''; hn=false; }
      }
      if(w.length>=2&&hn) words.push(w);
    }
    for(let c=0; c<BOARD_SIZE; c++) {
      let w='',hn=false;
      for(let r=0; r<BOARD_SIZE; r++) {
        if(tb[r][c]) { w+=tb[r][c].letter; if(tb[r][c].isNew) hn=true; }
        else { if(w.length>=2&&hn) words.push(w); w=''; hn=false; }
      }
      if(w.length>=2&&hn) words.push(w);
    }
    if(words.length===0 && tempTiles.length>0) {
      words.push(tempTiles.map(t=>t.letter).join(''));
    }
    return [...new Set(words)];
  };
  
  const checkWords = async (tempTiles) => {
    if(tempTiles.length === 0) { setWordPreview({valid:[],invalid:[]}); return; }
    const words = findWords(tempTiles);
    const results = await Promise.all(words.map(async (w) => ({word:w,valid:await checkWordWithTDK(w)})));
    setWordPreview({
      valid: results.filter(r=>r.valid).map(r=>r.word),
      invalid: results.filter(r=>!r.valid).map(r=>r.word)
    });
  };
  
  const calcScore = (tempTiles) => {
    let base=0,mult=1;
    tempTiles.forEach(t => {
      let pts = POINTS[t.letter]||0;
      if(TRIPLE_LETTER.some(([x,y])=>x===t.r&&y===t.c)&&!board[t.r][t.c]) pts*=3;
      if(DOUBLE_WORD.some(([x,y])=>x===t.r&&y===t.c)&&!board[t.r][t.c]) mult*=2;
      base+=pts;
    });
    return (tempTiles.length===7 ? base*mult*2 : base*mult);
  };
  
  const clickCell = (r,c) => {
    if(swapMode) return;
    vibrate(10);
    const exist = temp.find(t=>t.r===r&&t.c===c);
    if(exist) { 
      const newTemp = temp.filter(t=>!(t.r===r&&t.c===c));
      setTemp(newTemp);
      checkWords(newTemp);
      setSelectedLetter(null);
      return;
    }
    if(board[r][c]) return;
    const color = turn===1?p1Color:p2Color;
    if(!isValid(r,c,color)) { 
      vibrate([50, 50, 50]);
      setMsg('âš ï¸ Rakibe Ã§ok yakÄ±n!'); 
      setTimeout(()=>setMsg(''),2000);
      return;
    }
    if(selectedLetter) {
      vibrate(20);
      const newTemp = [...temp,{r,c,letter:selectedLetter.letter,idx:selectedLetter.idx,color,isJoker:selectedLetter.isJoker||false}];
      setTemp(newTemp);
      checkWords(newTemp);
      setSelectedLetter(null);
    }
  };
  
  const handleLetterClick = (letter, idx) => {
    if(temp.some(t => t.idx === idx)) return;
    vibrate(15);
    if(swapMode) {
      const isSelected = selectedSwap.includes(idx);
      if(isSelected) setSelectedSwap(selectedSwap.filter(i => i !== idx));
      else setSelectedSwap([...selectedSwap, idx]);
      return;
    }
    if(letter === '*') {
      setJokerIdx(idx);
      setShowJokerModal(true);
      return;
    }
    setSelectedLetter({letter, idx});
    setMsg('ðŸ“ Tahtada bir kareye tÄ±kla');
    setTimeout(() => setMsg(''), 3000);
  };
  
  const handlePlay = async () => {
    if(temp.length === 0) return;
    if(wordPreview.invalid.length > 0) {
      vibrate([100, 50, 100]);
      setMsg('âŒ GeÃ§ersiz: ' + wordPreview.invalid.join(', '));
      setTimeout(()=>setMsg(''),3000);
      return;
    }
    setChecking(true);
    const nb = board.map(row => [...row]);
    temp.forEach(t => { nb[t.r][t.c] = {letter:t.letter,color:t.color,isJoker:t.isJoker}; });
    const score = calcScore(temp);
    
    vibrate([50, 30, 50, 30, 50]);
    setScoreAnimation(true);
    
    if(turn === 1) {
      setP1Score(p1Score + score);
      const ui = temp.map(t => t.idx);
      const nh = p1Hand.filter((_,i) => !ui.includes(i));
      const dr = bag.slice(0, Math.min(temp.length, bag.length));
      setP1Hand(ensureVowels([...nh, ...dr]));
      setBag(bag.slice(dr.length));
    } else {
      setP2Score(p2Score + score);
      const ui = temp.map(t => t.idx);
      const nh = p2Hand.filter((_,i) => !ui.includes(i));
      const dr = bag.slice(0, Math.min(temp.length, bag.length));
      setP2Hand(ensureVowels([...nh, ...dr]));
      setBag(bag.slice(dr.length));
    }
    setBoard(nb);
    setTemp([]);
    setWordPreview({valid:[],invalid:[]});
    setMsg('ðŸŽ‰ +' + score + ' puan!');
    setTimeout(()=>setMsg(''),3000);
    setTurn(turn===1?2:1);
    setPassCount(0);
    setChecking(false);
  };
  
  const handlePass = () => {
    vibrate(30);
    const npc = passCount + 1;
    setPassCount(npc);
    if(npc >= 3) {
      setWinner(turn===1?2:1);
      setShowWinner(true);
      vibrate([100, 50, 100, 50, 100]);
      return;
    }
    setTemp([]);
    setWordPreview({valid:[],invalid:[]});
    setSelectedLetter(null);
    setTurn(turn===1?2:1);
    setMsg('â­ï¸ Pas geÃ§ildi');
    setTimeout(()=>setMsg(''),2000);
  };
  
  const handleShuffle = () => {
    vibrate(25);
    if(turn===1) setP1Hand([...p1Hand].sort(()=>Math.random()-0.5));
    else setP2Hand([...p2Hand].sort(()=>Math.random()-0.5));
  };
  
  const handleSwap = () => {
    if(selectedSwap.length===0) return;
    if(bag.length < selectedSwap.length) {
      vibrate([50, 50, 50]);
      setMsg('âš ï¸ Ã‡anta yetersiz');
      setTimeout(()=>setMsg(''),2000);
      return;
    }
    vibrate(40);
    const hand = turn===1 ? p1Hand : p2Hand;
    const nh = hand.filter((_,i) => !selectedSwap.includes(i));
    const dr = bag.slice(0, selectedSwap.length);
    const ret = selectedSwap.map(i => hand[i]);
    if(turn===1) setP1Hand(ensureVowels([...nh, ...dr]));
    else setP2Hand(ensureVowels([...nh, ...dr]));
    setBag([...bag.slice(dr.length), ...ret].sort(()=>Math.random()-0.5));
    setSwapMode(false);
    setSelectedSwap([]);
    setTurn(turn===1?2:1);
    setMsg('ðŸ”„ Harfler deÄŸiÅŸtirildi');
    setTimeout(()=>setMsg(''),2000);
  };
  
  const handleUndo = () => {
    vibrate(15);
    setTemp([]);
    setWordPreview({valid:[],invalid:[]});
    setSelectedLetter(null);
  };
  
  const handleReset = () => {
    vibrate(50);
    const nb = initBag();
    setBag(nb);
    setP1Hand(ensureVowels(nb.slice(0,7)));
    setP2Hand(ensureVowels(nb.slice(7,14)));
    setBoard(Array(BOARD_SIZE).fill(null).map(()=>Array(BOARD_SIZE).fill(null)));
    setTemp([]);
    setTurn(1);
    setP1Score(0);
    setP2Score(0);
    setMsg('');
    setWordPreview({valid:[],invalid:[]});
    setPassCount(0);
    setShowWinner(false);
    setWinner(null);
    setSelectedLetter(null);
  };
  
  const handleForfeit = () => {
    vibrate(100);
    setWinner(turn===1?2:1);
    setShowWinner(true);
  };
  
  const currentHand = turn===1 ? p1Hand : p2Hand;
  const tempScore = calcScore(temp);
  
  return h('div', {className:'min-h-screen bg-gradient-to-br from-purple-600 via-blue-600 to-cyan-600 p-2 sm:p-3'},
    h('div', {className:'max-w-7xl mx-auto'},
      // Score Header - Enhanced
      h('div', {className:'bg-white/95 backdrop-blur-xl rounded-2xl p-3 mb-3 shadow-2xl border-2 border-white/50'},
        h('div', {className:'flex justify-between items-center gap-3'},
          h('div', {
            className:'flex-1 flex items-center justify-between px-4 py-3 rounded-xl ' + 
              (turn===1?'bg-gradient-to-r from-red-500 to-red-600':'bg-red-400/50') + 
              ' text-white text-sm sm:text-base shadow-lg transition-all duration-300' +
              (scoreAnimation && turn===1 ? ' score-pop' : '')
          },
            h('div', {className:'flex items-center gap-2'},
              h('div', {className:'w-6 h-6 sm:w-8 sm:h-8 bg-white rounded-full flex items-center justify-center text-red-500 font-black text-sm sm:text-base shadow-md'}, '1'),
              h('span', {className:'font-black tracking-tight'}, 'Oyuncu 1')
            ),
            h('span', {className:'font-black text-lg sm:text-xl'}, p1Score)
          ),
          h('div', {
            className:'flex-1 flex items-center justify-between px-4 py-3 rounded-xl ' + 
              (turn===2?'bg-gradient-to-r from-yellow-500 to-yellow-600':'bg-yellow-400/50') + 
              ' text-white text-sm sm:text-base shadow-lg transition-all duration-300' +
              (scoreAnimation && turn===2 ? ' score-pop' : '')
          },
            h('div', {className:'flex items-center gap-2'},
              h('div', {className:'w-6 h-6 sm:w-8 sm:h-8 bg-white rounded-full flex items-center justify-center text-yellow-600 font-black text-sm sm:text-base shadow-md'}, '2'),
              h('span', {className:'font-black tracking-tight'}, 'Oyuncu 2')
            ),
            h('span', {className:'font-black text-lg sm:text-xl'}, p2Score)
          )
        ),
        h('div', {className:'text-gray-700 text-center mt-2 text-xs sm:text-sm font-semibold flex items-center justify-center gap-2'},
          h('span', {className:'bg-purple-100 px-3 py-1 rounded-full'}, 'ðŸŽ’ Ã‡anta: ' + bag.length),
          passCount > 0 && h('span', {className:'bg-red-100 px-3 py-1 rounded-full pulse-warning'}, 'âš ï¸ Pas: ' + passCount + '/3')
        )
      ),
      
      // Message Toast - Enhanced
      msg && h('div', {className:'text-center mb-3 message-toast'},
        h('div', {className:'inline-block bg-white px-6 py-3 rounded-xl shadow-2xl font-bold text-sm sm:text-base border-2 border-purple-200'}, msg)
      ),
      
      // Winner Modal - Enhanced
      showWinner && h('div', {className:'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4'},
        h('div', {className:'bg-white p-8 rounded-3xl shadow-2xl text-center max-w-sm w-full border-4 border-yellow-400'},
          h('div', {className:'text-7xl mb-4 animate-bounce'}, 'ðŸ†'),
          h('h2', {className:'text-3xl font-black mb-4 bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent'}, 'Oyuncu ' + winner + ' KazandÄ±!'),
          h('div', {className:'bg-gradient-to-r from-purple-50 to-blue-50 rounded-2xl p-4 mb-6'},
            h('p', {className:'text-xl font-bold mb-2 text-red-600'}, 'Oyuncu 1: ' + p1Score + ' puan'),
            h('p', {className:'text-xl font-bold text-yellow-600'}, 'Oyuncu 2: ' + p2Score + ' puan')
          ),
          h('button', {
            onClick:handleReset, 
            className:'bg-gradient-to-r from-green-500 to-green-600 text-white px-8 py-4 rounded-xl font-black hover:shadow-2xl text-xl btn transition-all duration-300 w-full'
          }, 'ðŸ”„ Yeni Oyun')
        )
      ),
      
      h('div', {className:'flex flex-col lg:flex-row gap-3 justify-center items-start'},
        // Board - Enhanced
        h('div', {className:'bg-white p-2 sm:p-3 rounded-2xl shadow-2xl border-4 border-white/50'},
          h('div', {
            className:'grid gap-[2px] sm:gap-1',
            style:{
              gridTemplateColumns:'repeat('+BOARD_SIZE+', 1fr)',
              width:'100%',
              maxWidth:'min(95vw, 700px)',
              aspectRatio:'1'
            }
          },
            ...Array(BOARD_SIZE).fill(null).map((_,r) => 
              Array(BOARD_SIZE).fill(null).map((__,c) => {
                const tile = board[r][c];
                const tempTile = temp.find(t => t.r===r && t.c===c);
                const isTL = TRIPLE_LETTER.some(([x,y]) => x===r&&y===c);
                const isDW = DOUBLE_WORD.some(([x,y]) => x===r&&y===c);
                const isCS = r===7 && c===7;
                let cc = 'board-cell';
                if(tile||tempTile) cc += ' font-black';
                else if(isTL) cc += ' triple-letter';
                else if(isDW) cc += ' double-word';
                else if(isCS) cc += ' center-star';
                const dt = tempTile||tile;
                return h('div', {
                  key:r+'-'+c,
                  className:cc,
                  onClick:()=>clickCell(r,c),
                  style:dt ? {
                    backgroundColor:dt.color,
                    color:'white',
                    cursor:'pointer',
                    boxShadow:'0 4px 8px rgba(0,0,0,0.2), inset 0 -2px 0 rgba(0,0,0,0.2)'
                  } : {cursor:'pointer'}
                }, dt ? dt.letter+(dt.isJoker?'â˜…':'') : isTL?'3Ã—H':isDW?'2Ã—K':isCS?'â˜…':'');
              })
            ).flat()
          )
        ),
        
        // Control Panel - Enhanced
        h('div', {className:'bg-white/95 backdrop-blur-xl p-3 sm:p-4 rounded-2xl shadow-2xl w-full lg:w-72 border-2 border-white/50'},
          h('div', {className:'mb-3'},
            h('h3', {className:'font-black mb-3 text-sm sm:text-base bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent'}, 
              'ðŸŽ® Oyuncu ' + turn + ' - Harfler'
            ),
            h('div', {className:'flex gap-1.5 flex-wrap justify-center'},
              ...currentHand.map((letter,idx) => {
                const isUsed = temp.some(t => t.idx===idx);
                const isSelected = selectedSwap.includes(idx);
                const isActive = selectedLetter && selectedLetter.idx === idx;
                return h('div', {
                  key:idx,
                  onClick:() => handleLetterClick(letter, idx),
                  className:'letter-tile w-10 h-10 sm:w-12 sm:h-12 flex flex-col items-center justify-center border-3 rounded-lg font-black text-sm sm:text-base relative ' + 
                    (isUsed ? 'opacity-30 cursor-not-allowed border-gray-300 disabled' :
                     isActive ? 'border-green-500 bg-green-50 selected glow' :
                     isSelected ? 'border-blue-500 bg-blue-50' :
                     'border-amber-500 bg-gradient-to-br from-yellow-50 to-amber-100 cursor-pointer'),
                  style:{borderWidth:'3px'}
                },
                  letter==='*' ? 'â­' : letter,
                  !isUsed && letter!=='*' && h('span', {className:'absolute bottom-0.5 right-1 text-[9px] font-bold text-gray-500 bg-white/80 px-1 rounded'}, POINTS[letter]||0)
                );
              })
            )
          ),
          
          // Word Preview - Enhanced
          (wordPreview.valid.length>0 || wordPreview.invalid.length>0) && h('div', {className:'mb-3 p-3 word-preview rounded-xl text-xs sm:text-sm shadow-inner'},
            wordPreview.valid.length>0 && h('div', {className:'text-green-600 font-bold mb-1'}, 'âœ… ' + wordPreview.valid.join(', ')),
            wordPreview.invalid.length>0 && h('div', {className:'text-red-600 font-bold mb-1'}, 'âŒ ' + wordPreview.invalid.join(', ')),
            temp.length>0 && h('div', {className:'text-blue-600 font-black text-base'}, 'ðŸŽ¯ +' + tempScore + ' puan')
          ),
          
          // Buttons - Enhanced
          h('div', {className:'space-y-2'},
            temp.length>0 && h('button', {
              onClick:handlePlay,
              disabled:checking||wordPreview.invalid.length>0,
              className:'btn btn-primary w-full text-white p-3 rounded-xl flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed font-black text-sm sm:text-base'
            }, checking ? 'â³ Kontrol ediliyor...' : 'â–¶ï¸ OYNA'),
            
            h('div', {className:'grid grid-cols-2 gap-2'},
              h('button', {onClick:handleUndo, disabled:temp.length===0, className:'btn bg-gradient-to-r from-orange-500 to-orange-600 text-white p-2 rounded-lg flex items-center justify-center hover:from-orange-600 hover:to-orange-700 disabled:opacity-50 font-bold text-xs sm:text-sm'}, 'â†¶ Geri'),
              h('button', {onClick:handleShuffle, disabled:temp.length>0, className:'btn bg-gradient-to-r from-gray-500 to-gray-600 text-white p-2 rounded-lg flex items-center justify-center hover:from-gray-600 hover:to-gray-700 font-bold text-xs sm:text-sm'}, 'ðŸ”€ KarÄ±ÅŸtÄ±r'),
              swapMode ?
                h('button', {onClick:handleSwap, disabled:selectedSwap.length===0, className:'btn bg-gradient-to-r from-blue-600 to-blue-700 text-white p-2 rounded-lg flex items-center justify-center hover:from-blue-700 hover:to-blue-800 disabled:opacity-50 font-bold text-xs sm:text-sm'}, 'âœ“ DeÄŸiÅŸtir ('+selectedSwap.length+')') :
                h('button', {onClick:()=>{vibrate(20);setSwapMode(true);}, disabled:temp.length>0, className:'btn bg-gradient-to-r from-blue-500 to-blue-600 text-white p-2 rounded-lg flex items-center justify-center hover:from-blue-600 hover:to-blue-700 disabled:opacity-50 font-bold text-xs sm:text-sm'}, 'ðŸ”„ DeÄŸiÅŸtir'),
              h('button', {onClick:handlePass, className:'btn bg-gradient-to-r from-gray-600 to-gray-700 text-white p-2 rounded-lg flex items-center justify-center hover:from-gray-700 hover:to-gray-800 font-bold text-xs sm:text-sm' + (passCount>0?' pulse-warning':'')}, 'â­ï¸ Pas' + (passCount>0 ? ' ('+passCount+'/3)' : ''))
            ),
            
            h('div', {className:'grid grid-cols-2 gap-2 pt-2 border-t-2 border-gray-200'},
              h('button', {onClick:handleReset, className:'btn bg-gradient-to-r from-red-500 to-red-600 text-white p-2 rounded-lg flex flex-col items-center justify-center hover:from-red-600 hover:to-red-700 font-bold text-xs sm:text-sm'}, 'ðŸ”„', h('span', {className:'text-[9px] mt-0.5'}, 'Yenile')),
              h('button', {onClick:handleForfeit, className:'btn bg-gradient-to-r from-purple-500 to-purple-600 text-white p-2 rounded-lg flex flex-col items-center justify-center hover:from-purple-600 hover:to-purple-700 font-bold text-xs sm:text-sm'}, 'ðŸ³ï¸', h('span', {className:'text-[9px] mt-0.5'}, 'Pes Et'))
            )
          )
        )
      )
    ),
    
    // Joker Modal - Enhanced
    showJokerModal && h('div', {className:'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4'},
      h('div', {className:'bg-white p-5 sm:p-7 rounded-3xl shadow-2xl max-w-md w-full border-4 border-yellow-400'},
        h('h3', {className:'text-xl sm:text-2xl font-black mb-4 text-center bg-gradient-to-r from-yellow-500 to-orange-500 bg-clip-text text-transparent'}, 'â­ Joker Harfi SeÃ§'),
        h('div', {className:'grid grid-cols-7 gap-1.5 sm:gap-2 mb-4'},
          ...LETTERS.map(letter => 
            h('button', {
              key:letter,
              onClick:() => {
                vibrate(30);
                const hand = turn===1 ? p1Hand : p2Hand;
                const nh = [...hand];
                nh[jokerIdx] = letter;
                if(turn===1) setP1Hand(nh);
                else setP2Hand(nh);
                setShowJokerModal(false);
                setJokerIdx(null);
                setSelectedLetter({letter,idx:jokerIdx,isJoker:true});
                setMsg('ðŸ“ Tahtada bir kareye tÄ±kla');
                setTimeout(() => setMsg(''), 3000);
              },
              className:'btn aspect-square bg-gradient-to-br from-yellow-100 to-amber-200 border-3 border-amber-500 rounded-lg font-black text-xs sm:text-sm hover:shadow-lg'
            }, letter)
          )
        ),
        h('button', {
          onClick:() => { vibrate(15); setShowJokerModal(false); setJokerIdx(null); },
          className:'btn w-full bg-gradient-to-r from-gray-500 to-gray-600 text-white py-3 rounded-xl font-black hover:from-gray-600 hover:to-gray-700'
        }, 'Ä°ptal')
      )
    )
  );
}

const root = createRoot(document.getElementById('root'));
root.render(h(Game));
    </script>
</body>
</html>
